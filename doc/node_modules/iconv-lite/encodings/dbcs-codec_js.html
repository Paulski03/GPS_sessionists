<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>dbcs-codec.js - RDoc Documentation</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "../../../";
  var index_rel_prefix = "../../../";
</script>

<script src="../../../js/jquery.js"></script>
<script src="../../../js/darkfish.js"></script>

<link href="../../../css/fonts.css" rel="stylesheet">
<link href="../../../css/rdoc.css" rel="stylesheet">



<body id="top" role="document" class="file">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../../../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../../../table_of_contents.html#pages">Pages</a>
    <a href="../../../table_of_contents.html#classes">Classes</a>
    <a href="../../../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="project-metadata">
    <div id="fileindex-section" class="nav-section">
  <h3>Pages</h3>

  <ul class="link-list">
  
    <li><a href="../../../Gemfile.html">Gemfile</a>
  
    <li><a href="../../../Gemfile_lock.html">Gemfile.lock</a>
  
    <li><a href="../../../README_md.html">README</a>
  
    <li><a href="../../../Rakefile.html">Rakefile</a>
  
    <li><a href="../../../app/assets/config/manifest_js.html">manifest.js</a>
  
    <li><a href="../../../app/assets/javascripts/application_js.html">application.js</a>
  
    <li><a href="../../../app/assets/javascripts/cable_js.html">cable.js</a>
  
    <li><a href="../../../app/assets/javascripts/pages_coffee.html">pages.coffee</a>
  
    <li><a href="../../../app/assets/stylesheets/application_css_scss.html">application.css.scss</a>
  
    <li><a href="../../../app/assets/stylesheets/custom_css_scss.html">custom.css.scss</a>
  
    <li><a href="../../../app/assets/stylesheets/pages_scss.html">pages.scss</a>
  
    <li><a href="../../../config_ru.html">config.ru</a>
  
    <li><a href="../../../log/development_log.html">development.log</a>
  
    <li><a href="../../../node_modules/addressparser/CHANGELOG_md.html">CHANGELOG</a>
  
    <li><a href="../../../node_modules/addressparser/LICENSE.html">LICENSE</a>
  
    <li><a href="../../../node_modules/addressparser/README_md.html">README</a>
  
    <li><a href="../../../node_modules/addressparser/lib/addressparser_js.html">addressparser.js</a>
  
    <li><a href="../../../node_modules/addressparser/package_json.html">package.json</a>
  
    <li><a href="../../../node_modules/async_ensureasync/README_md.html">README</a>
  
    <li><a href="../../../node_modules/async_ensureasync/index_js.html">index.js</a>
  
    <li><a href="../../../node_modules/async_ensureasync/package_json.html">package.json</a>
  
    <li><a href="../../../node_modules/async_queue/README_md.html">README</a>
  
    <li><a href="../../../node_modules/async_queue/index_js.html">index.js</a>
  
    <li><a href="../../../node_modules/async_queue/package_json.html">package.json</a>
  
    <li><a href="../../../node_modules/async_util_arrayeach/README_md.html">README</a>
  
    <li><a href="../../../node_modules/async_util_arrayeach/index_js.html">index.js</a>
  
    <li><a href="../../../node_modules/async_util_arrayeach/package_json.html">package.json</a>
  
    <li><a href="../../../node_modules/async_util_ensureasync/README_md.html">README</a>
  
    <li><a href="../../../node_modules/async_util_ensureasync/index_js.html">index.js</a>
  
    <li><a href="../../../node_modules/async_util_ensureasync/package_json.html">package.json</a>
  
    <li><a href="../../../node_modules/async_util_isarray/README_md.html">README</a>
  
    <li><a href="../../../node_modules/async_util_isarray/index_js.html">index.js</a>
  
    <li><a href="../../../node_modules/async_util_isarray/package_json.html">package.json</a>
  
    <li><a href="../../../node_modules/async_util_map/README_md.html">README</a>
  
    <li><a href="../../../node_modules/async_util_map/index_js.html">index.js</a>
  
    <li><a href="../../../node_modules/async_util_map/package_json.html">package.json</a>
  
    <li><a href="../../../node_modules/async_util_noop/README_md.html">README</a>
  
    <li><a href="../../../node_modules/async_util_noop/index_js.html">index.js</a>
  
    <li><a href="../../../node_modules/async_util_noop/package_json.html">package.json</a>
  
    <li><a href="../../../node_modules/async_util_onlyonce/README_md.html">README</a>
  
    <li><a href="../../../node_modules/async_util_onlyonce/index_js.html">index.js</a>
  
    <li><a href="../../../node_modules/async_util_onlyonce/package_json.html">package.json</a>
  
    <li><a href="../../../node_modules/async_util_queue/README_md.html">README</a>
  
    <li><a href="../../../node_modules/async_util_queue/index_js.html">index.js</a>
  
    <li><a href="../../../node_modules/async_util_queue/package_json.html">package.json</a>
  
    <li><a href="../../../node_modules/async_util_restparam/README_md.html">README</a>
  
    <li><a href="../../../node_modules/async_util_restparam/index_js.html">index.js</a>
  
    <li><a href="../../../node_modules/async_util_restparam/package_json.html">package.json</a>
  
    <li><a href="../../../node_modules/async_util_setimmediate/README_md.html">README</a>
  
    <li><a href="../../../node_modules/async_util_setimmediate/index_js.html">index.js</a>
  
    <li><a href="../../../node_modules/async_util_setimmediate/package_json.html">package.json</a>
  
    <li><a href="../../../node_modules/bottleneck/LICENSE.html">LICENSE</a>
  
    <li><a href="../../../node_modules/bottleneck/README_md.html">README</a>
  
    <li><a href="../../../node_modules/bottleneck/bottleneck_d_ts_ejs.html">bottleneck.d.ts.ejs</a>
  
    <li><a href="../../../node_modules/bottleneck/bottleneck_js.html">bottleneck.js</a>
  
    <li><a href="../../../node_modules/bottleneck/bottleneck_min_js.html">bottleneck.min.js</a>
  
    <li><a href="../../../node_modules/bottleneck/bower_json.html">bower.json</a>
  
    <li><a href="../../../node_modules/bottleneck/lib/Bottleneck_js.html">Bottleneck.js</a>
  
    <li><a href="../../../node_modules/bottleneck/lib/Cluster_js.html">Cluster.js</a>
  
    <li><a href="../../../node_modules/bottleneck/lib/DLList_js.html">DLList.js</a>
  
    <li><a href="../../../node_modules/bottleneck/lib/index_js.html">index.js</a>
  
    <li><a href="../../../node_modules/bottleneck/package_json.html">package.json</a>
  
    <li><a href="../../../node_modules/bottleneck/scripts/build_sh.html">build.sh</a>
  
    <li><a href="../../../node_modules/bottleneck/src/Bottleneck_coffee.html">Bottleneck.coffee</a>
  
    <li><a href="../../../node_modules/bottleneck/src/Cluster_coffee.html">Cluster.coffee</a>
  
    <li><a href="../../../node_modules/bottleneck/src/DLList_coffee.html">DLList.coffee</a>
  
    <li><a href="../../../node_modules/bottleneck/src/index_coffee.html">index.coffee</a>
  
    <li><a href="../../../node_modules/bottleneck/test_ts.html">test.ts</a>
  
    <li><a href="../../../node_modules/bottleneck/test/DLList_js.html">DLList.js</a>
  
    <li><a href="../../../node_modules/bottleneck/test/general_js.html">general.js</a>
  
    <li><a href="../../../node_modules/bottleneck/test/index_js.html">index.js</a>
  
    <li><a href="../../../node_modules/bottleneck/test/priority_js.html">priority.js</a>
  
    <li><a href="../../../node_modules/bottleneck/test/promises_js.html">promises.js</a>
  
    <li><a href="../../../node_modules/debug/CHANGELOG_md.html">CHANGELOG</a>
  
    <li><a href="../../../node_modules/debug/LICENSE.html">LICENSE</a>
  
    <li><a href="../../../node_modules/debug/Makefile.html">Makefile</a>
  
    <li><a href="../../../node_modules/debug/README_md.html">README</a>
  
    <li><a href="../../../node_modules/debug/component_json.html">component.json</a>
  
    <li><a href="../../../node_modules/debug/karma_conf_js.html">karma.conf.js</a>
  
    <li><a href="../../../node_modules/debug/node_js.html">node.js</a>
  
    <li><a href="../../../node_modules/debug/package_json.html">package.json</a>
  
    <li><a href="../../../node_modules/debug/src/browser_js.html">browser.js</a>
  
    <li><a href="../../../node_modules/debug/src/debug_js.html">debug.js</a>
  
    <li><a href="../../../node_modules/debug/src/index_js.html">index.js</a>
  
    <li><a href="../../../node_modules/debug/src/node_js.html">node.js</a>
  
    <li><a href="../../../node_modules/encoding/LICENSE.html">LICENSE</a>
  
    <li><a href="../../../node_modules/encoding/README_md.html">README</a>
  
    <li><a href="../../../node_modules/encoding/lib/encoding_js.html">encoding.js</a>
  
    <li><a href="../../../node_modules/encoding/lib/iconv-loader_js.html">iconv-loader.js</a>
  
    <li><a href="../../../node_modules/encoding/package_json.html">package.json</a>
  
    <li><a href="../../../node_modules/encoding/test/test_js.html">test.js</a>
  
    <li><a href="../../../node_modules/extend/CHANGELOG_md.html">CHANGELOG</a>
  
    <li><a href="../../../node_modules/extend/LICENSE.html">LICENSE</a>
  
    <li><a href="../../../node_modules/extend/README_md.html">README</a>
  
    <li><a href="../../../node_modules/extend/component_json.html">component.json</a>
  
    <li><a href="../../../node_modules/extend/index_js.html">index.js</a>
  
    <li><a href="../../../node_modules/extend/package_json.html">package.json</a>
  
    <li><a href="../../../node_modules/iconv-lite/Changelog_md.html">Changelog</a>
  
    <li><a href="../../../node_modules/iconv-lite/LICENSE.html">LICENSE</a>
  
    <li><a href="../../../node_modules/iconv-lite/README_md.html">README</a>
  
    <li><a href="../../../node_modules/iconv-lite/encodings/dbcs-codec_js.html">dbcs-codec.js</a>
  
    <li><a href="../../../node_modules/iconv-lite/encodings/dbcs-data_js.html">dbcs-data.js</a>
  
    <li><a href="../../../node_modules/iconv-lite/encodings/index_js.html">index.js</a>
  
    <li><a href="../../../node_modules/iconv-lite/encodings/internal_js.html">internal.js</a>
  
    <li><a href="../../../node_modules/iconv-lite/encodings/sbcs-codec_js.html">sbcs-codec.js</a>
  
    <li><a href="../../../node_modules/iconv-lite/encodings/sbcs-data-generated_js.html">sbcs-data-generated.js</a>
  
    <li><a href="../../../node_modules/iconv-lite/encodings/sbcs-data_js.html">sbcs-data.js</a>
  
    <li><a href="../../../node_modules/iconv-lite/encodings/tables/big5-added_json.html">big5-added.json</a>
  
    <li><a href="../../../node_modules/iconv-lite/encodings/tables/cp936_json.html">cp936.json</a>
  
    <li><a href="../../../node_modules/iconv-lite/encodings/tables/cp949_json.html">cp949.json</a>
  
    <li><a href="../../../node_modules/iconv-lite/encodings/tables/cp950_json.html">cp950.json</a>
  
    <li><a href="../../../node_modules/iconv-lite/encodings/tables/eucjp_json.html">eucjp.json</a>
  
    <li><a href="../../../node_modules/iconv-lite/encodings/tables/gb18030-ranges_json.html">gb18030-ranges.json</a>
  
    <li><a href="../../../node_modules/iconv-lite/encodings/tables/gbk-added_json.html">gbk-added.json</a>
  
    <li><a href="../../../node_modules/iconv-lite/encodings/tables/shiftjis_json.html">shiftjis.json</a>
  
    <li><a href="../../../node_modules/iconv-lite/encodings/utf16_js.html">utf16.js</a>
  
    <li><a href="../../../node_modules/iconv-lite/encodings/utf7_js.html">utf7.js</a>
  
    <li><a href="../../../node_modules/iconv-lite/lib/bom-handling_js.html">bom-handling.js</a>
  
    <li><a href="../../../node_modules/iconv-lite/lib/extend-node_js.html">extend-node.js</a>
  
    <li><a href="../../../node_modules/iconv-lite/lib/index_d_ts.html">index.d.ts</a>
  
    <li><a href="../../../node_modules/iconv-lite/lib/index_js.html">index.js</a>
  
    <li><a href="../../../node_modules/iconv-lite/lib/streams_js.html">streams.js</a>
  
    <li><a href="../../../node_modules/iconv-lite/package_json.html">package.json</a>
  
    <li><a href="../../../node_modules/lodash_chunk/LICENSE.html">LICENSE</a>
  
    <li><a href="../../../node_modules/lodash_chunk/README_md.html">README</a>
  
    <li><a href="../../../node_modules/lodash_chunk/index_js.html">index.js</a>
  
    <li><a href="../../../node_modules/lodash_chunk/package_json.html">package.json</a>
  
    <li><a href="../../../node_modules/mailparser/LICENSE.html">LICENSE</a>
  
    <li><a href="../../../node_modules/mailparser/README_md.html">README</a>
  
    <li><a href="../../../node_modules/mailparser/lib/datetime_js.html">datetime.js</a>
  
    <li><a href="../../../node_modules/mailparser/lib/mailparser_js.html">mailparser.js</a>
  
    <li><a href="../../../node_modules/mailparser/lib/streams_js.html">streams.js</a>
  
    <li><a href="../../../node_modules/mailparser/package_json.html">package.json</a>
  
    <li><a href="../../../node_modules/mailparser/test/mailparser_js.html">mailparser.js</a>
  
    <li><a href="../../../node_modules/mailparser/test/mixed_eml.html">mixed.eml</a>
  
    <li><a href="../../../node_modules/mailparser/test/nested_eml.html">nested.eml</a>
  
    <li><a href="../../../node_modules/mime/LICENSE.html">LICENSE</a>
  
    <li><a href="../../../node_modules/mime/README_md.html">README</a>
  
    <li><a href="../../../node_modules/mime/build/build_js.html">build.js</a>
  
    <li><a href="../../../node_modules/mime/build/test_js.html">test.js</a>
  
    <li><a href="../../../node_modules/mime/cli_js.html">cli.js</a>
  
    <li><a href="../../../node_modules/mime/mime_js.html">mime.js</a>
  
    <li><a href="../../../node_modules/mime/package_json.html">package.json</a>
  
    <li><a href="../../../node_modules/mime/types_json.html">types.json</a>
  
    <li><a href="../../../node_modules/mimelib/LICENSE.html">LICENSE</a>
  
    <li><a href="../../../node_modules/mimelib/README_md.html">README</a>
  
    <li><a href="../../../node_modules/mimelib/index_js.html">index.js</a>
  
    <li><a href="../../../node_modules/mimelib/lib/content-types-reversed_js.html">content-types-reversed.js</a>
  
    <li><a href="../../../node_modules/mimelib/lib/content-types_js.html">content-types.js</a>
  
    <li><a href="../../../node_modules/mimelib/lib/mimelib_js.html">mimelib.js</a>
  
    <li><a href="../../../node_modules/mimelib/package_json.html">package.json</a>
  
    <li><a href="../../../node_modules/ms/index_js.html">index.js</a>
  
    <li><a href="../../../node_modules/ms/license_md.html">license</a>
  
    <li><a href="../../../node_modules/ms/package_json.html">package.json</a>
  
    <li><a href="../../../node_modules/ms/readme_md.html">readme</a>
  
    <li><a href="../../../node_modules/sendgrid-rest/CHANGELOG_md.html">CHANGELOG</a>
  
    <li><a href="../../../node_modules/sendgrid-rest/CONTRIBUTING_md.html">CONTRIBUTING</a>
  
    <li><a href="../../../node_modules/sendgrid-rest/LICENSE_txt.html">LICENSE</a>
  
    <li><a href="../../../node_modules/sendgrid-rest/README_md.html">README</a>
  
    <li><a href="../../../node_modules/sendgrid-rest/examples/example_js.html">example.js</a>
  
    <li><a href="../../../node_modules/sendgrid-rest/lib/client_js.html">client.js</a>
  
    <li><a href="../../../node_modules/sendgrid-rest/package_json.html">package.json</a>
  
    <li><a href="../../../node_modules/sendgrid-rest/test/test_js.html">test.js</a>
  
    <li><a href="../../../node_modules/sendgrid/CHANGELOG_md.html">CHANGELOG</a>
  
    <li><a href="../../../node_modules/sendgrid/CONTRIBUTING_md.html">CONTRIBUTING</a>
  
    <li><a href="../../../node_modules/sendgrid/LICENSE_txt.html">LICENSE</a>
  
    <li><a href="../../../node_modules/sendgrid/README_md.html">README</a>
  
    <li><a href="../../../node_modules/sendgrid/TROUBLESHOOTING_md.html">TROUBLESHOOTING</a>
  
    <li><a href="../../../node_modules/sendgrid/USAGE_md.html">USAGE</a>
  
    <li><a href="../../../node_modules/sendgrid/USE_CASES_md.html">USE_CASES</a>
  
    <li><a href="../../../node_modules/sendgrid/examples/accesssettings/accesssettings_js.html">accesssettings.js</a>
  
    <li><a href="../../../node_modules/sendgrid/examples/alerts/alerts_js.html">alerts.js</a>
  
    <li><a href="../../../node_modules/sendgrid/examples/apikeys/apikeys_js.html">apikeys.js</a>
  
    <li><a href="../../../node_modules/sendgrid/examples/asm/asm_js.html">asm.js</a>
  
    <li><a href="../../../node_modules/sendgrid/examples/browsers/browsers_js.html">browsers.js</a>
  
    <li><a href="../../../node_modules/sendgrid/examples/campaigns/campaigns_js.html">campaigns.js</a>
  
    <li><a href="../../../node_modules/sendgrid/examples/categories/categories_js.html">categories.js</a>
  
    <li><a href="../../../node_modules/sendgrid/examples/clients/clients_js.html">clients.js</a>
  
    <li><a href="../../../node_modules/sendgrid/examples/contactdb/contactdb_js.html">contactdb.js</a>
  
    <li><a href="../../../node_modules/sendgrid/examples/devices/devices_js.html">devices.js</a>
  
    <li><a href="../../../node_modules/sendgrid/examples/geo/geo_js.html">geo.js</a>
  
    <li><a href="../../../node_modules/sendgrid/examples/helpers/mail/example_js.html">example.js</a>
  
    <li><a href="../../../node_modules/sendgrid/examples/ips/ips_js.html">ips.js</a>
  
    <li><a href="../../../node_modules/sendgrid/examples/mail/mail_js.html">mail.js</a>
  
    <li><a href="../../../node_modules/sendgrid/examples/mailboxproviders/mailboxproviders_js.html">mailboxproviders.js</a>
  
    <li><a href="../../../node_modules/sendgrid/examples/mailsettings/mailsettings_js.html">mailsettings.js</a>
  
    <li><a href="../../../node_modules/sendgrid/examples/partnersettings/partnersettings_js.html">partnersettings.js</a>
  
    <li><a href="../../../node_modules/sendgrid/examples/scopes/scopes_js.html">scopes.js</a>
  
    <li><a href="../../../node_modules/sendgrid/examples/senders/senders_js.html">senders.js</a>
  
    <li><a href="../../../node_modules/sendgrid/examples/stats/stats_js.html">stats.js</a>
  
    <li><a href="../../../node_modules/sendgrid/examples/subusers/subusers_js.html">subusers.js</a>
  
    <li><a href="../../../node_modules/sendgrid/examples/suppression/suppression_js.html">suppression.js</a>
  
    <li><a href="../../../node_modules/sendgrid/examples/templates/templates_js.html">templates.js</a>
  
    <li><a href="../../../node_modules/sendgrid/examples/trackingsettings/trackingsettings_js.html">trackingsettings.js</a>
  
    <li><a href="../../../node_modules/sendgrid/examples/user/user_js.html">user.js</a>
  
    <li><a href="../../../node_modules/sendgrid/examples/whitelabel/whitelabel_js.html">whitelabel.js</a>
  
    <li><a href="../../../node_modules/sendgrid/index_d_ts.html">index.d.ts</a>
  
    <li><a href="../../../node_modules/sendgrid/index_js.html">index.js</a>
  
    <li><a href="../../../node_modules/sendgrid/lib/helpers/contact-importer/contact-importer_js.html">contact-importer.js</a>
  
    <li><a href="../../../node_modules/sendgrid/lib/helpers/error_js.html">error.js</a>
  
    <li><a href="../../../node_modules/sendgrid/lib/helpers/inbound/parse_js.html">parse.js</a>
  
    <li><a href="../../../node_modules/sendgrid/lib/helpers/mail/README_md.html">README</a>
  
    <li><a href="../../../node_modules/sendgrid/lib/helpers/mail/mail_js.html">mail.js</a>
  
    <li><a href="../../../node_modules/sendgrid/lib/sendgrid_js.html">sendgrid.js</a>
  
    <li><a href="../../../node_modules/sendgrid/package_json.html">package.json</a>
  
    <li><a href="../../../node_modules/sendgrid/test/helpers/contact-importer/contact-importer_test_js.html">contact-importer.test.js</a>
  
    <li><a href="../../../node_modules/sendgrid/test/helpers/inbound/parse_test_js.html">parse.test.js</a>
  
    <li><a href="../../../node_modules/sendgrid/test/helpers/mail/test_js.html">test.js</a>
  
    <li><a href="../../../node_modules/sendgrid/test/prism_sh.html">prism.sh</a>
  
    <li><a href="../../../node_modules/sendgrid/test/test_js.html">test.js</a>
  
    <li><a href="../../../node_modules/sendgrid/tsconfig_json.html">tsconfig.json</a>
  
    <li><a href="../../../node_modules/uue/LICENSE.html">LICENSE</a>
  
    <li><a href="../../../node_modules/uue/README_md.html">README</a>
  
    <li><a href="../../../node_modules/uue/package_json.html">package.json</a>
  
    <li><a href="../../../node_modules/uue/uue_js.html">uue.js</a>
  
    <li><a href="../../../package-lock_json.html">package-lock.json</a>
  
    <li><a href="../../../package_json.html">package.json</a>
  
    <li><a href="../../../public/404_html.html">404.html</a>
  
    <li><a href="../../../public/422_html.html">422.html</a>
  
    <li><a href="../../../public/500_html.html">500.html</a>
  
    <li><a href="../../../public/apple-touch-icon-precomposed_png.html">apple-touch-icon-precomposed.png</a>
  
    <li><a href="../../../public/apple-touch-icon_png.html">apple-touch-icon.png</a>
  
    <li><a href="../../../public/favicon_ico.html">favicon.ico</a>
  
    <li><a href="../../../public/robots_txt.html">robots</a>
  
    <li><a href="../../../tmp/pids/server_pid.html">server.pid</a>
  
    <li><a href="../../../tmp/restart_txt.html">restart</a>
  
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-label="Page node_modules/iconv-lite/encodings/dbcs-codec.js">

<p>“use strict”; var Buffer = require(“buffer”).Buffer;</p>

<p>// Multibyte codec. In this scheme, a character is represented by 1 or more
bytes. // Our codec supports UTF-16 surrogates, extensions for GB18030 and
unicode sequences. // To save memory and loading time, we read table files
only when requested.</p>

<p>exports._dbcs = DBCSCodec;</p>

<p>var UNASSIGNED = -1,</p>

<pre>GB18030_CODE = -2,
SEQ_START  = -10,
NODE_START = -1000,
UNASSIGNED_NODE = new Array(0x100),
DEF_CHAR = -1;</pre>

<p>for (var i = 0; i &lt; 0x100; i++)</p>

<pre class="ruby"><span class="ruby-constant">UNASSIGNED_NODE</span>[<span class="ruby-identifier">i</span>] = <span class="ruby-constant">UNASSIGNED</span>;
</pre>

<p>// Class DBCSCodec reads and initializes mapping tables. function
DBCSCodec(codecOptions, iconv) {</p>

<pre>this.encodingName = codecOptions.encodingName;
if (!codecOptions)
    throw new Error(&quot;DBCS codec is called without the data.&quot;)
if (!codecOptions.table)
    throw new Error(&quot;Encoding &#39;&quot; + this.encodingName + &quot;&#39; has no data.&quot;);

// Load tables.
var mappingTable = codecOptions.table();

// Decode tables: MBCS -&gt; Unicode.

// decodeTables is a trie, encoded as an array of arrays of integers. Internal arrays are trie nodes and all have len = 256.
// Trie root is decodeTables[0].
// Values: &gt;=  0 -&gt; unicode character code. can be &gt; 0xFFFF
//         == UNASSIGNED -&gt; unknown/unassigned sequence.
//         == GB18030_CODE -&gt; this is the end of a GB18030 4-byte sequence.
//         &lt;= NODE_START -&gt; index of the next node in our trie to process next byte.
//         &lt;= SEQ_START  -&gt; index of the start of a character code sequence, in decodeTableSeq.
this.decodeTables = [];
this.decodeTables[0] = UNASSIGNED_NODE.slice(0); // Create root node.

// Sometimes a MBCS char corresponds to a sequence of unicode chars. We store them as arrays of integers here. 
this.decodeTableSeq = [];

// Actual mapping tables consist of chunks. Use them to fill up decode tables.
for (var i = 0; i &lt; mappingTable.length; i++)
    this._addDecodeChunk(mappingTable[i]);

this.defaultCharUnicode = iconv.defaultCharUnicode;

// Encode tables: Unicode -&gt; DBCS.

// `encodeTable` is array mapping from unicode char to encoded char. All its values are integers for performance.
// Because it can be sparse, it is represented as array of buckets by 256 chars each. Bucket can be null.
// Values: &gt;=  0 -&gt; it is a normal char. Write the value (if &lt;=256 then 1 byte, if &lt;=65536 then 2 bytes, etc.).
//         == UNASSIGNED -&gt; no conversion found. Output a default char.
//         &lt;= SEQ_START  -&gt; it&#39;s an index in encodeTableSeq, see below. The character starts a sequence.
this.encodeTable = [];

// `encodeTableSeq` is used when a sequence of unicode characters is encoded as a single code. We use a tree of
// objects where keys correspond to characters in sequence and leafs are the encoded dbcs values. A special DEF_CHAR key
// means end of sequence (needed when one sequence is a strict subsequence of another).
// Objects are kept separately from encodeTable to increase performance.
this.encodeTableSeq = [];

// Some chars can be decoded, but need not be encoded.
var skipEncodeChars = {};
if (codecOptions.encodeSkipVals)
    for (var i = 0; i &lt; codecOptions.encodeSkipVals.length; i++) {
        var val = codecOptions.encodeSkipVals[i];
        if (typeof val === &#39;number&#39;)
            skipEncodeChars[val] = true;
        else
            for (var j = val.from; j &lt;= val.to; j++)
                skipEncodeChars[j] = true;
    }

// Use decode trie to recursively fill out encode tables.
this._fillEncodeTable(0, 0, skipEncodeChars);

// Add more encoding pairs when needed.
if (codecOptions.encodeAdd) {
    for (var uChar in codecOptions.encodeAdd)
        if (Object.prototype.hasOwnProperty.call(codecOptions.encodeAdd, uChar))
            this._setEncodeChar(uChar.charCodeAt(0), codecOptions.encodeAdd[uChar]);
}

this.defCharSB  = this.encodeTable[0][iconv.defaultCharSingleByte.charCodeAt(0)];
if (this.defCharSB === UNASSIGNED) this.defCharSB = this.encodeTable[0][&#39;?&#39;];
if (this.defCharSB === UNASSIGNED) this.defCharSB = &quot;?&quot;.charCodeAt(0);

// Load &amp; create GB18030 tables when needed.
if (typeof codecOptions.gb18030 === &#39;function&#39;) {
    this.gb18030 = codecOptions.gb18030(); // Load GB18030 ranges.

    // Add GB18030 decode tables.
    var thirdByteNodeIdx = this.decodeTables.length;
    var thirdByteNode = this.decodeTables[thirdByteNodeIdx] = UNASSIGNED_NODE.slice(0);

    var fourthByteNodeIdx = this.decodeTables.length;
    var fourthByteNode = this.decodeTables[fourthByteNodeIdx] = UNASSIGNED_NODE.slice(0);

    for (var i = 0x81; i &lt;= 0xFE; i++) {
        var secondByteNodeIdx = NODE_START - this.decodeTables[0][i];
        var secondByteNode = this.decodeTables[secondByteNodeIdx];
        for (var j = 0x30; j &lt;= 0x39; j++)
            secondByteNode[j] = NODE_START - thirdByteNodeIdx;
    }
    for (var i = 0x81; i &lt;= 0xFE; i++)
        thirdByteNode[i] = NODE_START - fourthByteNodeIdx;
    for (var i = 0x30; i &lt;= 0x39; i++)
        fourthByteNode[i] = GB18030_CODE
}</pre>

<p>}</p>

<p>DBCSCodec.prototype.encoder = DBCSEncoder; DBCSCodec.prototype.decoder =
DBCSDecoder;</p>

<p>// Decoder helpers DBCSCodec.prototype._getDecodeTrieNode = function(addr)
{</p>

<pre>var bytes = [];
for (; addr &gt; 0; addr &gt;&gt;= 8)
    bytes.push(addr &amp; 0xFF);
if (bytes.length == 0)
    bytes.push(0);

var node = this.decodeTables[0];
for (var i = bytes.length-1; i &gt; 0; i--) { // Traverse nodes deeper into the trie.
    var val = node[bytes[i]];

    if (val == UNASSIGNED) { // Create new node.
        node[bytes[i]] = NODE_START - this.decodeTables.length;
        this.decodeTables.push(node = UNASSIGNED_NODE.slice(0));
    }
    else if (val &lt;= NODE_START) { // Existing node.
        node = this.decodeTables[NODE_START - val];
    }
    else
        throw new Error(&quot;Overwrite byte in &quot; + this.encodingName + &quot;, addr: &quot; + addr.toString(16));
}
return node;</pre>

<p>}</p>

<p>DBCSCodec.prototype._addDecodeChunk = function(chunk) {</p>

<pre>// First element of chunk is the hex mbcs code where we start.
var curAddr = parseInt(chunk[0], 16);

// Choose the decoding node where we&#39;ll write our chars.
var writeTable = this._getDecodeTrieNode(curAddr);
curAddr = curAddr &amp; 0xFF;

// Write all other elements of the chunk to the table.
for (var k = 1; k &lt; chunk.length; k++) {
    var part = chunk[k];
    if (typeof part === &quot;string&quot;) { // String, write as-is.
        for (var l = 0; l &lt; part.length;) {
            var code = part.charCodeAt(l++);
            if (0xD800 &lt;= code &amp;&amp; code &lt; 0xDC00) { // Decode surrogate
                var codeTrail = part.charCodeAt(l++);
                if (0xDC00 &lt;= codeTrail &amp;&amp; codeTrail &lt; 0xE000)
                    writeTable[curAddr++] = 0x10000 + (code - 0xD800) * 0x400 + (codeTrail - 0xDC00);
                else
                    throw new Error(&quot;Incorrect surrogate pair in &quot;  + this.encodingName + &quot; at chunk &quot; + chunk[0]);
            }
            else if (0x0FF0 &lt; code &amp;&amp; code &lt;= 0x0FFF) { // Character sequence (our own encoding used)
                var len = 0xFFF - code + 2;
                var seq = [];
                for (var m = 0; m &lt; len; m++)
                    seq.push(part.charCodeAt(l++)); // Simple variation: don&#39;t support surrogates or subsequences in seq.

                writeTable[curAddr++] = SEQ_START - this.decodeTableSeq.length;
                this.decodeTableSeq.push(seq);
            }
            else
                writeTable[curAddr++] = code; // Basic char
        }
    } 
    else if (typeof part === &quot;number&quot;) { // Integer, meaning increasing sequence starting with prev character.
        var charCode = writeTable[curAddr - 1] + 1;
        for (var l = 0; l &lt; part; l++)
            writeTable[curAddr++] = charCode++;
    }
    else
        throw new Error(&quot;Incorrect type &#39;&quot; + typeof part + &quot;&#39; given in &quot;  + this.encodingName + &quot; at chunk &quot; + chunk[0]);
}
if (curAddr &gt; 0xFF)
    throw new Error(&quot;Incorrect chunk in &quot;  + this.encodingName + &quot; at addr &quot; + chunk[0] + &quot;: too long&quot; + curAddr);</pre>

<p>}</p>

<p>// Encoder helpers DBCSCodec.prototype._getEncodeBucket = function(uCode) {</p>

<pre>var high = uCode &gt;&gt; 8; // This could be &gt; 0xFF because of astral characters.
if (this.encodeTable[high] === undefined)
    this.encodeTable[high] = UNASSIGNED_NODE.slice(0); // Create bucket on demand.
return this.encodeTable[high];</pre>

<p>}</p>

<p>DBCSCodec.prototype._setEncodeChar = function(uCode, dbcsCode) {</p>

<pre>var bucket = this._getEncodeBucket(uCode);
var low = uCode &amp; 0xFF;
if (bucket[low] &lt;= SEQ_START)
    this.encodeTableSeq[SEQ_START-bucket[low]][DEF_CHAR] = dbcsCode; // There&#39;s already a sequence, set a single-char subsequence of it.
else if (bucket[low] == UNASSIGNED)
    bucket[low] = dbcsCode;</pre>

<p>}</p>

<p>DBCSCodec.prototype._setEncodeSequence = function(seq, dbcsCode) {</p>

<pre>// Get the root of character tree according to first character of the sequence.
var uCode = seq[0];
var bucket = this._getEncodeBucket(uCode);
var low = uCode &amp; 0xFF;

var node;
if (bucket[low] &lt;= SEQ_START) {
    // There&#39;s already a sequence with  - use it.
    node = this.encodeTableSeq[SEQ_START-bucket[low]];
}
else {
    // There was no sequence object - allocate a new one.
    node = {};
    if (bucket[low] !== UNASSIGNED) node[DEF_CHAR] = bucket[low]; // If a char was set before - make it a single-char subsequence.
    bucket[low] = SEQ_START - this.encodeTableSeq.length;
    this.encodeTableSeq.push(node);
}

// Traverse the character tree, allocating new nodes as needed.
for (var j = 1; j &lt; seq.length-1; j++) {
    var oldVal = node[uCode];
    if (typeof oldVal === &#39;object&#39;)
        node = oldVal;
    else {
        node = node[uCode] = {}
        if (oldVal !== undefined)
            node[DEF_CHAR] = oldVal
    }
}

// Set the leaf to given dbcsCode.
uCode = seq[seq.length-1];
node[uCode] = dbcsCode;</pre>

<p>}</p>

<p>DBCSCodec.prototype._fillEncodeTable = function(nodeIdx, prefix,
skipEncodeChars) {</p>

<pre>var node = this.decodeTables[nodeIdx];
for (var i = 0; i &lt; 0x100; i++) {
    var uCode = node[i];
    var mbCode = prefix + i;
    if (skipEncodeChars[mbCode])
        continue;

    if (uCode &gt;= 0)
        this._setEncodeChar(uCode, mbCode);
    else if (uCode &lt;= NODE_START)
        this._fillEncodeTable(NODE_START - uCode, mbCode &lt;&lt; 8, skipEncodeChars);
    else if (uCode &lt;= SEQ_START)
        this._setEncodeSequence(this.decodeTableSeq[SEQ_START - uCode], mbCode);
}</pre>

<p>}</p>

<p>// == Encoder
==================================================================</p>

<p>function DBCSEncoder(options, codec) {</p>

<pre>// Encoder state
this.leadSurrogate = -1;
this.seqObj = undefined;

// Static data
this.encodeTable = codec.encodeTable;
this.encodeTableSeq = codec.encodeTableSeq;
this.defaultCharSingleByte = codec.defCharSB;
this.gb18030 = codec.gb18030;</pre>

<p>}</p>

<p>DBCSEncoder.prototype.write = function(str) {</p>

<pre>var newBuf = new Buffer(str.length * (this.gb18030 ? 4 : 3)), 
    leadSurrogate = this.leadSurrogate,
    seqObj = this.seqObj, nextChar = -1,
    i = 0, j = 0;

while (true) {
    // 0. Get next character.
    if (nextChar === -1) {
        if (i == str.length) break;
        var uCode = str.charCodeAt(i++);
    }
    else {
        var uCode = nextChar;
        nextChar = -1;    
    }

    // 1. Handle surrogates.
    if (0xD800 &lt;= uCode &amp;&amp; uCode &lt; 0xE000) { // Char is one of surrogates.
        if (uCode &lt; 0xDC00) { // We&#39;ve got lead surrogate.
            if (leadSurrogate === -1) {
                leadSurrogate = uCode;
                continue;
            } else {
                leadSurrogate = uCode;
                // Double lead surrogate found.
                uCode = UNASSIGNED;
            }
        } else { // We&#39;ve got trail surrogate.
            if (leadSurrogate !== -1) {
                uCode = 0x10000 + (leadSurrogate - 0xD800) * 0x400 + (uCode - 0xDC00);
                leadSurrogate = -1;
            } else {
                // Incomplete surrogate pair - only trail surrogate found.
                uCode = UNASSIGNED;
            }

        }
    }
    else if (leadSurrogate !== -1) {
        // Incomplete surrogate pair - only lead surrogate found.
        nextChar = uCode; uCode = UNASSIGNED; // Write an error, then current char.
        leadSurrogate = -1;
    }

    // 2. Convert uCode character.
    var dbcsCode = UNASSIGNED;
    if (seqObj !== undefined &amp;&amp; uCode != UNASSIGNED) { // We are in the middle of the sequence
        var resCode = seqObj[uCode];
        if (typeof resCode === &#39;object&#39;) { // Sequence continues.
            seqObj = resCode;
            continue;

        } else if (typeof resCode == &#39;number&#39;) { // Sequence finished. Write it.
            dbcsCode = resCode;

        } else if (resCode == undefined) { // Current character is not part of the sequence.

            // Try default character for this sequence
            resCode = seqObj[DEF_CHAR];
            if (resCode !== undefined) {
                dbcsCode = resCode; // Found. Write it.
                nextChar = uCode; // Current character will be written too in the next iteration.

            } else {
                // TODO: What if we have no default? (resCode == undefined)
                // Then, we should write first char of the sequence as-is and try the rest recursively.
                // Didn&#39;t do it for now because no encoding has this situation yet.
                // Currently, just skip the sequence and write current char.
            }
        }
        seqObj = undefined;
    }
    else if (uCode &gt;= 0) {  // Regular character
        var subtable = this.encodeTable[uCode &gt;&gt; 8];
        if (subtable !== undefined)
            dbcsCode = subtable[uCode &amp; 0xFF];

        if (dbcsCode &lt;= SEQ_START) { // Sequence start
            seqObj = this.encodeTableSeq[SEQ_START-dbcsCode];
            continue;
        }

        if (dbcsCode == UNASSIGNED &amp;&amp; this.gb18030) {
            // Use GB18030 algorithm to find character(s) to write.
            var idx = findIdx(this.gb18030.uChars, uCode);
            if (idx != -1) {
                var dbcsCode = this.gb18030.gbChars[idx] + (uCode - this.gb18030.uChars[idx]);
                newBuf[j++] = 0x81 + Math.floor(dbcsCode / 12600); dbcsCode = dbcsCode % 12600;
                newBuf[j++] = 0x30 + Math.floor(dbcsCode / 1260); dbcsCode = dbcsCode % 1260;
                newBuf[j++] = 0x81 + Math.floor(dbcsCode / 10); dbcsCode = dbcsCode % 10;
                newBuf[j++] = 0x30 + dbcsCode;
                continue;
            }
        }
    }

    // 3. Write dbcsCode character.
    if (dbcsCode === UNASSIGNED)
        dbcsCode = this.defaultCharSingleByte;

    if (dbcsCode &lt; 0x100) {
        newBuf[j++] = dbcsCode;
    }
    else if (dbcsCode &lt; 0x10000) {
        newBuf[j++] = dbcsCode &gt;&gt; 8;   // high byte
        newBuf[j++] = dbcsCode &amp; 0xFF; // low byte
    }
    else {
        newBuf[j++] = dbcsCode &gt;&gt; 16;
        newBuf[j++] = (dbcsCode &gt;&gt; 8) &amp; 0xFF;
        newBuf[j++] = dbcsCode &amp; 0xFF;
    }
}

this.seqObj = seqObj;
this.leadSurrogate = leadSurrogate;
return newBuf.slice(0, j);</pre>

<p>}</p>

<p>DBCSEncoder.prototype.end = function() {</p>

<pre>if (this.leadSurrogate === -1 &amp;&amp; this.seqObj === undefined)
    return; // All clean. Most often case.

var newBuf = new Buffer(10), j = 0;

if (this.seqObj) { // We&#39;re in the sequence.
    var dbcsCode = this.seqObj[DEF_CHAR];
    if (dbcsCode !== undefined) { // Write beginning of the sequence.
        if (dbcsCode &lt; 0x100) {
            newBuf[j++] = dbcsCode;
        }
        else {
            newBuf[j++] = dbcsCode &gt;&gt; 8;   // high byte
            newBuf[j++] = dbcsCode &amp; 0xFF; // low byte
        }
    } else {
        // See todo above.
    }
    this.seqObj = undefined;
}

if (this.leadSurrogate !== -1) {
    // Incomplete surrogate pair - only lead surrogate found.
    newBuf[j++] = this.defaultCharSingleByte;
    this.leadSurrogate = -1;
}

return newBuf.slice(0, j);</pre>

<p>}</p>

<p>// Export for testing DBCSEncoder.prototype.findIdx = findIdx;</p>

<p>// == Decoder
==================================================================</p>

<p>function DBCSDecoder(options, codec) {</p>

<pre>// Decoder state
this.nodeIdx = 0;
this.prevBuf = new Buffer(0);

// Static data
this.decodeTables = codec.decodeTables;
this.decodeTableSeq = codec.decodeTableSeq;
this.defaultCharUnicode = codec.defaultCharUnicode;
this.gb18030 = codec.gb18030;</pre>

<p>}</p>

<p>DBCSDecoder.prototype.write = function(buf) {</p>

<pre>var newBuf = new Buffer(buf.length*2),
    nodeIdx = this.nodeIdx, 
    prevBuf = this.prevBuf, prevBufOffset = this.prevBuf.length,
    seqStart = -this.prevBuf.length, // idx of the start of current parsed sequence.
    uCode;

if (prevBufOffset &gt; 0) // Make prev buf overlap a little to make it easier to slice later.
    prevBuf = Buffer.concat([prevBuf, buf.slice(0, 10)]);

for (var i = 0, j = 0; i &lt; buf.length; i++) {
    var curByte = (i &gt;= 0) ? buf[i] : prevBuf[i + prevBufOffset];

    // Lookup in current trie node.
    var uCode = this.decodeTables[nodeIdx][curByte];

    if (uCode &gt;= 0) { 
        // Normal character, just use it.
    }
    else if (uCode === UNASSIGNED) { // Unknown char.
        // TODO: Callback with seq.
        //var curSeq = (seqStart &gt;= 0) ? buf.slice(seqStart, i+1) : prevBuf.slice(seqStart + prevBufOffset, i+1 + prevBufOffset);
        i = seqStart; // Try to parse again, after skipping first byte of the sequence (&#39;i&#39; will be incremented by &#39;for&#39; cycle).
        uCode = this.defaultCharUnicode.charCodeAt(0);
    }
    else if (uCode === GB18030_CODE) {
        var curSeq = (seqStart &gt;= 0) ? buf.slice(seqStart, i+1) : prevBuf.slice(seqStart + prevBufOffset, i+1 + prevBufOffset);
        var ptr = (curSeq[0]-0x81)*12600 + (curSeq[1]-0x30)*1260 + (curSeq[2]-0x81)*10 + (curSeq[3]-0x30);
        var idx = findIdx(this.gb18030.gbChars, ptr);
        uCode = this.gb18030.uChars[idx] + ptr - this.gb18030.gbChars[idx];
    }
    else if (uCode &lt;= NODE_START) { // Go to next trie node.
        nodeIdx = NODE_START - uCode;
        continue;
    }
    else if (uCode &lt;= SEQ_START) { // Output a sequence of chars.
        var seq = this.decodeTableSeq[SEQ_START - uCode];
        for (var k = 0; k &lt; seq.length - 1; k++) {
            uCode = seq[k];
            newBuf[j++] = uCode &amp; 0xFF;
            newBuf[j++] = uCode &gt;&gt; 8;
        }
        uCode = seq[seq.length-1];
    }
    else
        throw new Error(&quot;iconv-lite internal error: invalid decoding table value &quot; + uCode + &quot; at &quot; + nodeIdx + &quot;/&quot; + curByte);

    // Write the character to buffer, handling higher planes using surrogate pair.
    if (uCode &gt; 0xFFFF) { 
        uCode -= 0x10000;
        var uCodeLead = 0xD800 + Math.floor(uCode / 0x400);
        newBuf[j++] = uCodeLead &amp; 0xFF;
        newBuf[j++] = uCodeLead &gt;&gt; 8;

        uCode = 0xDC00 + uCode % 0x400;
    }
    newBuf[j++] = uCode &amp; 0xFF;
    newBuf[j++] = uCode &gt;&gt; 8;

    // Reset trie node.
    nodeIdx = 0; seqStart = i+1;
}

this.nodeIdx = nodeIdx;
this.prevBuf = (seqStart &gt;= 0) ? buf.slice(seqStart) : prevBuf.slice(seqStart + prevBufOffset);
return newBuf.slice(0, j).toString(&#39;ucs2&#39;);</pre>

<p>}</p>

<p>DBCSDecoder.prototype.end = function() {</p>

<pre>var ret = &#39;&#39;;

// Try to parse all remaining chars.
while (this.prevBuf.length &gt; 0) {
    // Skip 1 character in the buffer.
    ret += this.defaultCharUnicode;
    var buf = this.prevBuf.slice(1);

    // Parse remaining as usual.
    this.prevBuf = new Buffer(0);
    this.nodeIdx = 0;
    if (buf.length &gt; 0)
        ret += this.write(buf);
}

this.nodeIdx = 0;
return ret;</pre>

<p>}</p>

<p>// Binary search for GB18030. Returns largest i such that <a
href="i">table</a> &lt;= val. function findIdx(table, val) {</p>

<pre>if (table[0] &gt; val)
    return -1;

var l = 0, r = table.length;
while (l &lt; r-1) { // always table[l] &lt;= val &lt; table[r]
    var mid = l + Math.floor((r-l+1)/2);
    if (table[mid] &lt;= val)
        l = mid;
    else
        r = mid;
}
return l;</pre>

<p>}</p>
</main>



<footer id="validator-badges" role="contentinfo">
  <p><a href="http://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="https://rdoc.github.io/rdoc">RDoc</a> 5.0.0.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

